<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Générateur Devis - Chirurgie V4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f1f5f9;
            -webkit-tap-highlight-color: transparent;
        }
        .clinic-btn.active {
            background-color: #2563eb;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2), 0 2px 4px -1px rgba(37, 99, 235, 0.1);
            border-color: #2563eb;
        }
        .fade-in {
            animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        /* Style pour input désactivé */
        select:disabled {
            background-color: #e2e8f0;
            color: #64748b;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col text-slate-800 pb-20 md:pb-0">

    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-slate-200 sticky top-0 z-30">
        <div class="max-w-4xl mx-auto px-4 py-3 md:py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 text-white w-9 h-9 md:w-10 md:h-10 flex items-center justify-center rounded-lg shadow-blue-200 shadow-md">
                    <i class="fa-solid fa-calculator text-sm md:text-base"></i>
                </div>
                <div>
                    <h1 class="text-base md:text-lg font-bold text-slate-800 leading-tight">Calculateur Honoraires</h1>
                    <p class="text-[10px] md:text-xs text-slate-500 font-medium">Outil Coordinatrice</p>
                </div>
            </div>
            <div class="hidden md:block text-xs font-mono bg-slate-100 px-2 py-1 rounded text-slate-500">
                V4-ETOILE
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow container max-w-4xl mx-auto px-4 py-4 md:py-8 space-y-4 md:space-y-6">
        
        <!-- Selection Card -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 md:p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8">
                <!-- Intervention -->
                <div class="space-y-2">
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2">
                        <i class="fa-solid fa-list-ul text-blue-500"></i> 1. Intervention
                    </label>
                    <div class="relative">
                        <select id="interventionSelect" class="block w-full pl-3 pr-10 py-3 text-base border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 rounded-lg border bg-slate-50 transition-shadow cursor-pointer active:bg-white touch-manipulation">
                            <option value="">-- Sélectionner --</option>
                            <!-- JS populates this -->
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-500">
                            <i class="fa-solid fa-chevron-down text-xs"></i>
                        </div>
                    </div>
                </div>

                <!-- Clinique -->
                <div class="space-y-2">
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2">
                        <i class="fa-regular fa-building text-blue-500"></i> 2. Clinique
                    </label>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="setClinic('alphand')" id="btn-alphand" class="clinic-btn py-3 px-1 rounded-lg text-sm font-semibold border border-transparent bg-slate-100 text-slate-600 touch-manipulation transition-all duration-200 flex flex-col md:flex-row items-center justify-center gap-1 md:gap-2">
                            <span class="block md:hidden"><i class="fa-solid fa-a"></i></span>
                            <span>Alphand</span>
                        </button>
                        <button onclick="setClinic('etoile')" id="btn-etoile" class="clinic-btn py-3 px-1 rounded-lg text-sm font-semibold border border-transparent bg-slate-100 text-slate-600 touch-manipulation transition-all duration-200 flex flex-col md:flex-row items-center justify-center gap-1 md:gap-2">
                            <span class="block md:hidden"><i class="fa-solid fa-star text-[10px]"></i></span>
                            <span>Étoile</span>
                        </button>
                        <button onclick="setClinic('biarritz')" id="btn-biarritz" class="clinic-btn py-3 px-1 rounded-lg text-sm font-semibold border border-transparent bg-slate-100 text-slate-600 touch-manipulation transition-all duration-200 flex flex-col md:flex-row items-center justify-center gap-1 md:gap-2">
                            <span class="block md:hidden"><i class="fa-solid fa-water"></i></span>
                            <span>Biarritz</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Parameters (Collapsible/Contextual) -->
            <div id="params-panel" class="mt-4 md:mt-6 pt-4 md:pt-6 border-t border-slate-100 hidden fade-in">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-xs font-bold text-slate-500 uppercase tracking-wider">Paramètres</span>
                </div>
                <div class="grid grid-cols-2 gap-3 md:gap-4">
                    <div class="relative group">
                        <label class="text-[10px] text-slate-400 block mb-1 uppercase">Durée</label>
                        <input type="number" id="inputDuration" class="block w-full text-base border-slate-200 rounded-lg bg-slate-50 focus:bg-white focus:ring-blue-500 focus:border-blue-500 p-2.5 border font-mono">
                        <div class="absolute right-3 top-8 text-xs text-slate-400 pointer-events-none">min</div>
                    </div>
                    <div>
                        <label class="text-[10px] text-slate-400 block mb-1 uppercase">Type</label>
                        <select id="inputType" class="block w-full text-base border-slate-200 rounded-lg bg-slate-50 focus:bg-white focus:ring-blue-500 focus:border-blue-500 p-2.5 border h-[46px] transition-colors">
                            <option value="Ambulatoire">Ambulatoire</option>
                            <option value="Hospit 1 nuit">Hospit 1 nuit</option>
                        </select>
                        <div id="etoile-msg" class="text-[10px] text-orange-500 mt-1 hidden"><i class="fa-solid fa-circle-info mr-1"></i>Étoile = Ambulatoire unique</div>
                    </div>
                </div>
                 <!-- New: Quick reset for HC -->
                 <div class="mt-3 flex justify-end">
                    <button onclick="resetHC()" class="text-xs text-blue-600 active:text-blue-800 py-2 px-2 -mr-2" title="Remettre le prix Biarritz">
                        <i class="fa-solid fa-rotate-left mr-1"></i>Reset Honoraires
                    </button>
                </div>
            </div>
        </div>

        <!-- Result Card -->
        <div id="resultCard" class="hidden fade-in mb-8">
            <div class="bg-white rounded-xl shadow-lg border border-blue-100 overflow-hidden relative">
                <!-- Top Accent -->
                <div class="h-1.5 w-full bg-blue-600"></div>

                <div class="p-4 md:p-6">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-2">
                        <div>
                            <h2 class="text-lg md:text-xl font-bold text-slate-800 leading-snug" id="resTitle">--</h2>
                            <div class="flex flex-wrap items-center gap-2 mt-1">
                                <span class="px-2 py-0.5 rounded text-[10px] md:text-xs font-medium bg-blue-50 text-blue-700 border border-blue-100 whitespace-nowrap" id="badgeClinic">--</span>
                                <span class="px-2 py-0.5 rounded text-[10px] md:text-xs font-medium bg-slate-50 text-slate-600 border border-slate-100 whitespace-nowrap" id="badgeTime">-- min</span>
                            </div>
                        </div>
                        <div class="w-full md:w-auto text-right mt-2 md:mt-0 pt-2 md:pt-0 border-t md:border-t-0 border-dashed border-slate-100 flex md:block justify-between items-center">
                            <p class="text-xs text-slate-400 uppercase font-semibold mb-0 md:mb-1">Total Estimé</p>
                            <p class="text-2xl md:text-3xl font-bold text-blue-600 tracking-tight" id="resTotal">0 €</p>
                        </div>
                    </div>

                    <!-- Pricing Table -->
                    <div class="space-y-3">
                        
                        <!-- Row: HC -->
                        <div class="flex items-center justify-between p-3 rounded-lg bg-white border border-slate-100 active:scale-[0.99] transition-transform group touch-manipulation">
                            <div class="flex items-center gap-3">
                                <div class="w-9 h-9 md:w-10 md:h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-600 flex-shrink-0">
                                    <i class="fa-solid fa-user-doctor text-sm md:text-base"></i>
                                </div>
                                <div class="min-w-0">
                                    <p class="text-sm font-semibold text-slate-700 truncate">Chirurgien</p>
                                    <p class="text-[10px] md:text-xs text-slate-400 truncate">Honoraire libre</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="number" id="valHC" class="w-20 md:w-24 text-right font-mono text-base font-bold text-slate-700 bg-transparent border-b border-transparent focus:border-blue-500 focus:outline-none transition-colors p-0 rounded-none" value="0">
                                <span class="text-slate-400 text-sm hidden md:inline">€</span>
                                <button onclick="copyToClipboard('valHC')" class="w-10 h-10 -mr-2 rounded-full active:bg-blue-50 text-slate-300 active:text-blue-600 transition-colors flex items-center justify-center touch-manipulation">
                                    <i class="fa-regular fa-copy"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Row: Anesth -->
                        <div class="flex items-center justify-between p-3 rounded-lg bg-white border border-slate-100 active:scale-[0.99] transition-transform group touch-manipulation">
                            <div class="flex items-center gap-3">
                                <div class="w-9 h-9 md:w-10 md:h-10 rounded-full bg-teal-50 flex items-center justify-center text-teal-600 flex-shrink-0">
                                    <i class="fa-solid fa-syringe text-sm md:text-base"></i>
                                </div>
                                <div class="min-w-0">
                                    <p class="text-sm font-semibold text-slate-700 truncate">Anesthésie</p>
                                    <p class="text-[10px] md:text-xs text-slate-400 truncate" id="descAnesth">--</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-20 md:w-24 text-right font-mono text-base font-bold text-slate-700 block" id="valAnesth">0</span>
                                <span class="text-slate-400 text-sm hidden md:inline">€</span>
                                <button onclick="copyToClipboard('valAnesth', true)" class="w-10 h-10 -mr-2 rounded-full active:bg-teal-50 text-slate-300 active:text-teal-600 transition-colors flex items-center justify-center touch-manipulation">
                                    <i class="fa-regular fa-copy"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Row: Clinic -->
                        <div class="flex items-center justify-between p-3 rounded-lg bg-white border border-slate-100 active:scale-[0.99] transition-transform group touch-manipulation">
                            <div class="flex items-center gap-3">
                                <div class="w-9 h-9 md:w-10 md:h-10 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-600 flex-shrink-0">
                                    <i class="fa-solid fa-hospital text-sm md:text-base"></i>
                                </div>
                                <div class="min-w-0">
                                    <p class="text-sm font-semibold text-slate-700 truncate">Clinique / Bloc</p>
                                    <p class="text-[10px] md:text-xs text-slate-400 truncate max-w-[120px] md:max-w-none" id="descClinic">--</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-20 md:w-24 text-right font-mono text-base font-bold text-slate-700 block" id="valClinic">0</span>
                                <span class="text-slate-400 text-sm hidden md:inline">€</span>
                                <button onclick="copyToClipboard('valClinic', true)" class="w-10 h-10 -mr-2 rounded-full active:bg-indigo-50 text-slate-300 active:text-indigo-600 transition-colors flex items-center justify-center touch-manipulation">
                                    <i class="fa-regular fa-copy"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Row: Stay -->
                        <div id="rowStay" class="flex items-center justify-between p-3 rounded-lg bg-white border border-slate-100 active:scale-[0.99] transition-transform group touch-manipulation">
                            <div class="flex items-center gap-3">
                                <div class="w-9 h-9 md:w-10 md:h-10 rounded-full bg-orange-50 flex items-center justify-center text-orange-600 flex-shrink-0">
                                    <i class="fa-solid fa-bed text-sm md:text-base"></i>
                                </div>
                                <div class="min-w-0">
                                    <p class="text-sm font-semibold text-slate-700 truncate">Hébergement</p>
                                    <p class="text-[10px] md:text-xs text-slate-400 truncate text-orange-600 font-medium" id="descStay">--</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-20 md:w-24 text-right font-mono text-base font-bold text-slate-700 block" id="valStay">0</span>
                                <span class="text-slate-400 text-sm hidden md:inline">€</span>
                                <button onclick="copyToClipboard('valStay', true)" class="w-10 h-10 -mr-2 rounded-full active:bg-orange-50 text-slate-300 active:text-orange-600 transition-colors flex items-center justify-center touch-manipulation">
                                    <i class="fa-regular fa-copy"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Row: Implants -->
                        <div id="rowImplants" class="hidden flex items-center justify-between p-3 rounded-lg bg-pink-50 border border-pink-100 active:scale-[0.99] transition-transform group touch-manipulation">
                            <div class="flex items-center gap-3">
                                <div class="w-9 h-9 md:w-10 md:h-10 rounded-full bg-white flex items-center justify-center text-pink-600 flex-shrink-0">
                                    <i class="fa-solid fa-shapes text-sm md:text-base"></i>
                                </div>
                                <div class="min-w-0">
                                    <p class="text-sm font-semibold text-slate-700 truncate">Prothèses</p>
                                    <p class="text-[10px] md:text-xs text-pink-500 truncate">Matériel inclus</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-20 md:w-24 text-right font-mono text-base font-bold text-slate-700 block" id="valImplants">0</span>
                                <span class="text-slate-400 text-sm hidden md:inline">€</span>
                                <button onclick="copyToClipboard('valImplants', true)" class="w-10 h-10 -mr-2 rounded-full active:bg-white text-pink-300 active:text-pink-600 transition-colors flex items-center justify-center touch-manipulation">
                                    <i class="fa-regular fa-copy"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <p class="text-center text-[10px] text-slate-400 mt-4 px-4">
                * Les prix calculés pour Paris se basent sur les durées théoriques. Suppléments possibles.
            </p>
        </div>

        <!-- Initial State -->
        <div id="emptyState" class="flex flex-col items-center justify-center py-12 text-slate-300">
            <i class="fa-solid fa-laptop-medical text-5xl md:text-6xl mb-4 text-slate-200"></i>
            <p class="text-sm font-medium">Sélectionnez une intervention</p>
        </div>

    </main>

    <!-- Toast Notification (Top Center Mobile, Top Right Desktop) -->
    <div id="toast" class="fixed top-4 left-1/2 -translate-x-1/2 md:left-auto md:translate-x-0 md:right-4 bg-slate-900/90 backdrop-blur text-white px-4 py-3 rounded-full shadow-2xl flex items-center gap-3 transition-all duration-300 opacity-0 -translate-y-20 z-50 pointer-events-none">
        <i class="fa-solid fa-check text-green-400"></i>
        <span class="text-sm font-medium">Copié dans le presse-papier</span>
    </div>

    <script>
        /**
         * DB: Base de données des interventions.
         * Source: Synthèse Interventions.pdf & Grille Biarritz 2026.
         * Note: Validé pour mobile.
         */
        const db = {
            "Abdominoplastie": { duration: 120, type: "Hospit 1 nuit", biarritz: { hc: 4200, anesth: 550, fso: 726, sejour: 533, implants: 0 } },
            "Abdominoplastie + Cure hernie": { duration: 120, type: "Hospit 1 nuit", biarritz: { hc: 4200, anesth: 550, fso: 726, sejour: 533, implants: 0 } },
            "Ablation de prothèses": { duration: 60, type: "Ambulatoire", biarritz: { hc: 3600, anesth: 400, fso: 145.20, sejour: 408, implants: 0 } },
            "Ablation prothèses + Mastopexie": { duration: 120, type: "Ambulatoire", biarritz: { hc: 5500, anesth: 550, fso: 726, sejour: 408, implants: 0 } },
            "Augmentation Mammaire": { duration: 60, type: "Ambulatoire", biarritz: { hc: 3900, anesth: 450, fso: 435.60, sejour: 408, implants: 680 } },
            "Augmentation Mammaire Composite": { duration: 90, type: "Ambulatoire", biarritz: { hc: 4800, anesth: 750, fso: 726, sejour: 408, implants: 680 } },
            "Blépharoplastie 4 paupières": { duration: 120, type: "Ambulatoire", biarritz: { hc: 4500, anesth: 300, fso: 435.60, sejour: 408, implants: 0 } },
            "Blépharoplastie Inférieure": { duration: 90, type: "Ambulatoire", biarritz: { hc: 3500, anesth: 300, fso: 290.40, sejour: 408, implants: 0 } },
            "Blépharoplastie Supérieure": { duration: 60, type: "Ambulatoire", biarritz: { hc: 2600, anesth: 300, fso: 290.40, sejour: 408, implants: 0 } },
            "Changement de prothèses": { duration: 120, type: "Ambulatoire", biarritz: { hc: 4500, anesth: 450, fso: 290.40, sejour: 408, implants: 680 } },
            "Changement prothèses + Mastopexie": { duration: 150, type: "Ambulatoire", biarritz: { hc: 5500, anesth: 550, fso: 726, sejour: 408, implants: 680 } },
            "Lifting de bras": { duration: 120, type: "Ambulatoire", biarritz: { hc: 3900, anesth: 450, fso: 580.80, sejour: 408, implants: 0 } },
            "Lipoaspiration 1 site": { duration: 60, type: "Ambulatoire", biarritz: { hc: 3600, anesth: 450, fso: 726, sejour: 408, implants: 0 } },
            "Lipoaspiration 2 sites": { duration: 120, type: "Ambulatoire", biarritz: { hc: 4500, anesth: 450, fso: 726, sejour: 408, implants: 0 } },
            "Lipoaspiration 3 sites": { duration: 150, type: "Ambulatoire", biarritz: { hc: 5500, anesth: 550, fso: 726, sejour: 408, implants: 0 } },
            "Lipo DLA": { duration: 120, type: "Hospit 1 nuit", biarritz: { hc: 4800, anesth: 650, fso: 726, sejour: 533, implants: 0 } },
            "DLA + Lipo 1 site": { duration: 150, type: "Hospit 1 nuit", biarritz: { hc: 4900, anesth: 1000, fso: 726, sejour: 533, implants: 0 } },
            "Lipofilling mammaire >200g": { duration: 120, type: "Ambulatoire", biarritz: { hc: 4800, anesth: 650, fso: 726, sejour: 408, implants: 0 } },
            "Mastopexie": { duration: 90, type: "Ambulatoire", biarritz: { hc: 4200, anesth: 500, fso: 580.80, sejour: 408, implants: 0 } },
            "Mastopexie + Implants": { duration: 120, type: "Ambulatoire", biarritz: { hc: 4800, anesth: 550, fso: 726, sejour: 408, implants: 680 } },
            "Rhinoplastie": { duration: 210, type: "Ambulatoire", biarritz: { hc: 5800, anesth: 400, fso: 1016.40, sejour: 408, implants: 0 } },
            "Septoplastie seule": { duration: 150, type: "Ambulatoire", biarritz: { hc: 0, anesth: 0, fso: 0, sejour: 0, implants: 0, note: "PEC Sécu" } }
        };

        let currentClinic = 'alphand';
        let currentKey = '';

        // Initialization
        document.addEventListener('DOMContentLoaded', () => {
            const select = document.getElementById('interventionSelect');
            Object.keys(db).sort().forEach(key => {
                const opt = document.createElement('option');
                opt.value = key;
                opt.textContent = key;
                select.appendChild(opt);
            });

            select.addEventListener('change', (e) => {
                currentKey = e.target.value;
                if(currentKey) {
                    loadInterventionData(currentKey);
                } else {
                    document.getElementById('emptyState').classList.remove('hidden');
                    document.getElementById('resultCard').classList.add('hidden');
                    document.getElementById('params-panel').classList.add('hidden');
                }
            });

            document.getElementById('inputDuration').addEventListener('input', calculate);
            document.getElementById('inputType').addEventListener('change', calculate);
            document.getElementById('valHC').addEventListener('input', () => {
                updateTotal();
            });

            setClinic('alphand');
        });

        function loadInterventionData(key) {
            const data = db[key];
            document.getElementById('inputDuration').value = data.duration;
            
            // Logic to restore type based on clinic
            if (currentClinic === 'etoile') {
                document.getElementById('inputType').value = 'Ambulatoire';
            } else {
                document.getElementById('inputType').value = data.type;
            }
            
            resetHC();
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('resultCard').classList.remove('hidden');
            document.getElementById('params-panel').classList.remove('hidden');
            calculate();
        }

        function resetHC() {
            if(!currentKey) return;
            const data = db[currentKey];
            const defaultHC = data.biarritz ? data.biarritz.hc : 0;
            document.getElementById('valHC').value = defaultHC;
            calculate();
        }

        function setClinic(clinic) {
            currentClinic = clinic;
            document.querySelectorAll('.clinic-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${clinic}`).classList.add('active');
            
            const names = { alphand: "Alphand", etoile: "Étoile", biarritz: "Biarritz" };
            document.getElementById('badgeClinic').textContent = names[clinic];
            
            // Handle Etoile specific Logic (Force Ambulatoire)
            const typeSelect = document.getElementById('inputType');
            const etoileMsg = document.getElementById('etoile-msg');
            
            if (clinic === 'etoile') {
                typeSelect.value = 'Ambulatoire';
                typeSelect.disabled = true;
                etoileMsg.classList.remove('hidden');
            } else {
                typeSelect.disabled = false;
                etoileMsg.classList.add('hidden');
                // Restore type if intervention is selected
                if(currentKey) {
                   typeSelect.value = db[currentKey].type; 
                }
            }

            if(currentKey) calculate();
        }

        function calculate() {
            if (!currentKey) return;

            const duration = parseInt(document.getElementById('inputDuration').value) || 0;
            const type = document.getElementById('inputType').value;
            const data = db[currentKey];

            let anesth = 0;
            let clinicCost = 0;
            let stay = 0;
            let implants = (data.biarritz && data.biarritz.implants) ? data.biarritz.implants : 0;

            if (currentClinic === 'alphand') {
                const blocks30 = Math.ceil(duration / 30);
                const billingDuration = blocks30 * 30; 
                clinicCost = blocks30 * 375;

                if (billingDuration <= 60) {
                    anesth = 500;
                } else {
                    const extraMins = billingDuration - 60;
                    const extraBlocks = Math.ceil(extraMins / 30);
                    anesth = 500 + (extraBlocks * 100);
                }
                stay = (type === "Hospit 1 nuit") ? 650 : 350;
                
                document.getElementById('descClinic').textContent = `Bloc (${billingDuration} min)`;
                document.getElementById('descAnesth').textContent = "500€ + 100€/30min";
                document.getElementById('descStay').textContent = type === "Hospit 1 nuit" ? "Nuit" : "Ambulatoire";
                document.getElementById('rowStay').classList.remove('hidden');
            }
            else if (currentClinic === 'etoile') {
                const blocks15 = Math.ceil(duration / 15);
                clinicCost = blocks15 * 190;

                if (duration <= 60) {
                    anesth = 500;
                } else {
                    const extraMins = duration - 60;
                    const extraBlocks = Math.ceil(extraMins / 30);
                    anesth = 500 + (extraBlocks * 100);
                }
                // FIXED: Stay forced to 0 for Etoile, but shown as included
                stay = 0;
                
                document.getElementById('descClinic').textContent = `190€ / 15 min`;
                document.getElementById('descAnesth').textContent = "Idem Alphand";
                
                // Show stay as Included
                document.getElementById('descStay').textContent = "Inclus dans le bloc";
                document.getElementById('rowStay').classList.remove('hidden');
            }
            else if (currentClinic === 'biarritz') {
                if (data.biarritz) {
                    anesth = data.biarritz.anesth;
                    clinicCost = data.biarritz.fso;
                    stay = data.biarritz.sejour;
                }
                document.getElementById('descClinic').textContent = "Forfait Salle";
                document.getElementById('descAnesth').textContent = "Forfait";
                document.getElementById('descStay').textContent = "Forfait Séjour";
                document.getElementById('rowStay').classList.remove('hidden');
            }

            document.getElementById('resTitle').textContent = currentKey;
            document.getElementById('badgeTime').textContent = duration + " min";
            
            document.getElementById('valAnesth').textContent = anesth;
            document.getElementById('valClinic').textContent = formatPrice(clinicCost);
            document.getElementById('valStay').textContent = stay;

            if (implants > 0) {
                document.getElementById('rowImplants').classList.remove('hidden');
                document.getElementById('rowImplants').classList.add('flex');
                document.getElementById('valImplants').textContent = implants;
            } else {
                document.getElementById('rowImplants').classList.add('hidden');
                document.getElementById('rowImplants').classList.remove('flex');
                document.getElementById('valImplants').textContent = 0;
            }

            updateTotal();
        }

        function formatPrice(num) {
            return parseFloat(num).toFixed(2).replace('.00', '');
        }

        function updateTotal() {
            const hc = parseFloat(document.getElementById('valHC').value) || 0;
            const anesth = parseFloat(document.getElementById('valAnesth').textContent) || 0;
            const clinic = parseFloat(document.getElementById('valClinic').textContent) || 0;
            
            const stayElem = document.getElementById('rowStay');
            const stay = (!stayElem.classList.contains('hidden')) ? parseFloat(document.getElementById('valStay').textContent) || 0 : 0;
            
            const impElem = document.getElementById('rowImplants');
            const implants = (!impElem.classList.contains('hidden')) ? parseFloat(document.getElementById('valImplants').textContent) || 0 : 0;

            const total = hc + anesth + clinic + stay + implants;
            
            const formatter = new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' });
            document.getElementById('resTotal').textContent = formatter.format(total);
        }

        function copyToClipboard(elementId, isText) {
            let val = isText ? document.getElementById(elementId).textContent : document.getElementById(elementId).value;
            // Fallback for iOS clipboard which sometimes requires user interaction context or text selection
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(val).then(() => showToast());
            } else {
                // Fallback approach
                const textArea = document.createElement("textarea");
                textArea.value = val;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showToast();
                } catch (err) {
                    console.error('Fallback copy failed', err);
                }
                document.body.removeChild(textArea);
            }
        }

        function showToast() {
            const toast = document.getElementById('toast');
            toast.classList.remove('opacity-0', '-translate-y-20');
            setTimeout(() => toast.classList.add('opacity-0', '-translate-y-20'), 2000);
        }

    </script>
</body>
</html>
