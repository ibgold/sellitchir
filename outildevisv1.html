<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Générateur Devis - Chirurgie V10</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
        }
        .clinic-btn.active {
            background-color: #1e293b;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-color: #1e293b;
        }
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        select:disabled { background-color: #f1f5f9; color: #94a3b8; cursor: not-allowed; }
        .toggle-checkbox:checked { right: 0; border-color: #22c55e; }
        .toggle-checkbox:checked + .toggle-label { background-color: #22c55e; }
        .toggle-checkbox:checked + .toggle-label:before { transform: translateX(100%); }
        .badge-secu { background-color: #dcfce7; color: #166534; border: 1px solid #bbf7d0; font-size: 0.65rem; padding: 2px 6px; border-radius: 9999px; margin-left: 6px; font-weight: 700; text-transform: uppercase; }
    </style>
</head>
<body class="min-h-screen flex flex-col text-slate-800 pb-20 md:pb-0">

    <header class="bg-white shadow-sm border-b border-slate-200 sticky top-0 z-30">
        <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-slate-900 text-white w-10 h-10 flex items-center justify-center rounded-lg shadow-lg">
                    <i class="fa-solid fa-calculator text-lg"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-slate-900 leading-tight">Expert Pricing</h1>
                    <p class="text-xs text-slate-500 font-medium tracking-wide">V10 : HÉBERGEMENT ÉTOILE</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-[10px] uppercase font-bold text-slate-400 hidden md:block">Harmonisation</span>
                <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                    <input type="checkbox" name="toggle" id="toggleHarmonization" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer z-10 transition-all duration-300 left-0 top-0 checked:left-6 border-slate-300 checked:border-green-500"/>
                    <label for="toggleHarmonization" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer transition-colors duration-300 checked:bg-green-500"></label>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow container max-w-4xl mx-auto px-4 py-6 space-y-6">
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5 md:p-6 relative overflow-hidden">
            <div class="relative z-10 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8">
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">1. Intervention</label>
                        <div class="relative">
                            <select id="interventionSelect" class="block w-full pl-4 pr-10 py-3 text-base border-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-500 rounded-lg border bg-slate-50 cursor-pointer hover:bg-white">
                                <option value="">-- Sélectionner --</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-400"><i class="fa-solid fa-chevron-down text-xs"></i></div>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">2. Lieu</label>
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="setClinic('alphand')" id="btn-alphand" class="clinic-btn py-3 px-1 rounded-lg text-sm font-semibold border border-transparent bg-slate-100 text-slate-500 transition-all flex flex-col items-center justify-center gap-1"><span>Alphand</span><span class="text-[9px] opacity-70 font-normal">Paris 16</span></button>
                            <button onclick="setClinic('etoile')" id="btn-etoile" class="clinic-btn py-3 px-1 rounded-lg text-sm font-semibold border border-transparent bg-slate-100 text-slate-500 transition-all flex flex-col items-center justify-center gap-1"><span>Étoile</span><span class="text-[9px] opacity-70 font-normal">Paris 17</span></button>
                            <button onclick="setClinic('biarritz')" id="btn-biarritz" class="clinic-btn py-3 px-1 rounded-lg text-sm font-semibold border border-transparent bg-slate-100 text-slate-500 transition-all flex flex-col items-center justify-center gap-1"><span>Biarritz</span><span class="text-[9px] opacity-70 font-normal">Basque</span></button>
                        </div>
                    </div>
                </div>
                <div id="params-panel" class="pt-4 border-t border-slate-100 hidden fade-in">
                    <div class="flex flex-wrap gap-4 items-end">
                        <div class="w-24">
                            <label class="text-[10px] text-slate-400 block mb-1 uppercase">Durée (min)</label>
                            <input type="number" id="inputDuration" class="w-full text-sm font-mono border-slate-200 rounded bg-slate-50 p-2 border text-center">
                        </div>
                        
                        <!-- Type selector (Standard) -->
                        <div class="w-32">
                            <label class="text-[10px] text-slate-400 block mb-1 uppercase">Type</label>
                            <select id="inputType" class="w-full text-sm border-slate-200 rounded bg-slate-50 p-2 border h-[38px]">
                                <option value="Ambulatoire">Ambulatoire</option>
                                <option value="Hospit 1 nuit">Hospit 1 nuit</option>
                            </select>
                        </div>

                        <!-- Etoile Specific Accommodation Selector -->
                        <div id="etoile-stay-container" class="hidden w-40">
                            <label class="text-[10px] text-orange-500 font-bold block mb-1 uppercase"><i class="fa-solid fa-bed mr-1"></i>Confort Étoile</label>
                            <select id="etoileStay" class="w-full text-sm border-orange-200 rounded bg-orange-50 p-2 border h-[38px] text-orange-900 font-medium focus:ring-orange-500 focus:border-orange-500">
                                <option value="260">Box (260€)</option>
                                <option value="360">Ch. Double (360€)</option>
                                <option value="420">Ch. Seule (420€)</option>
                            </select>
                        </div>

                        <div class="flex-grow text-right pb-2 flex flex-col items-end justify-center">
                             <div id="etoile-warning" class="hidden text-xs text-orange-400 font-medium mb-1 mr-1">Ambulatoire forcé</div>
                             <div id="harmonization-status" class="text-[10px] uppercase font-bold text-slate-400 transition-colors">Mode Standard</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="resultCard" class="hidden fade-in relative transition-all duration-300">
            <div id="profitBadge" class="absolute -top-3 -right-2 md:right-4 z-20 hidden">
                <div class="bg-green-600 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg border-2 border-white flex items-center gap-1 animate-bounce">
                    <i class="fa-solid fa-arrow-trend-up"></i><span id="profitAmount">+0 €</span>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                <div class="bg-slate-900 p-6 text-white flex justify-between items-center transition-colors duration-300" id="resultHeader">
                    <div>
                        <h2 class="text-xl font-bold" id="resTitle">--</h2>
                        <div class="flex items-center gap-2 mt-1 opacity-80">
                            <span class="text-xs bg-white/20 px-2 py-0.5 rounded" id="badgeClinic">--</span>
                            <span class="text-xs bg-white/20 px-2 py-0.5 rounded" id="badgeTime">-- min</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] uppercase tracking-widest opacity-60 mb-1">Total Patient</p>
                        <p class="text-3xl font-bold tracking-tight" id="resTotal">0 €</p>
                    </div>
                </div>

                <div class="p-4 md:p-6 space-y-4">
                    <div id="rowHC" class="flex items-center justify-between p-4 rounded-xl bg-slate-50 border border-slate-200 transition-all duration-300 shadow-sm">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full bg-white text-slate-700 flex items-center justify-center shadow-sm" id="iconHC"><i class="fa-solid fa-user-doctor text-xl"></i></div>
                            <div>
                                <p class="text-sm font-bold text-slate-800 uppercase tracking-wide">Honoraires Chirurgien</p>
                                <p class="text-xs text-slate-500 font-medium mt-0.5 transition-colors" id="hcSubtitle">Standard</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="flex flex-col items-end"><input type="number" id="valHC" class="w-28 text-right font-mono text-2xl font-bold text-slate-900 bg-transparent border-b border-transparent focus:border-slate-400 focus:outline-none p-0 transition-colors" value="0"></div>
                            <span class="text-slate-400 text-lg">€</span>
                            <button onclick="copyToClipboard('valHC')" class="w-8 h-8 rounded-full hover:bg-slate-200 text-slate-400 hover:text-slate-700 transition-colors flex items-center justify-center"><i class="fa-regular fa-copy"></i></button>
                        </div>
                    </div>

                    <div class="flex items-center gap-2 py-2"><div class="h-px bg-slate-100 flex-grow"></div><span class="text-[10px] text-slate-400 uppercase font-semibold">Frais Techniques</span><div class="h-px bg-slate-100 flex-grow"></div></div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div class="flex items-center justify-between p-3 rounded-lg bg-slate-50 border border-slate-100">
                            <div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-white text-teal-600 flex items-center justify-center shadow-sm"><i class="fa-solid fa-syringe text-xs"></i></div><div><p class="text-xs font-bold text-slate-700">Anesthésie</p><p class="text-[10px] text-slate-400" id="descAnesth">--</p></div></div>
                            <div class="flex items-center gap-2"><span class="font-mono font-bold text-slate-700" id="valAnesth">0</span><span class="text-slate-400 text-xs">€</span><button onclick="copyToClipboard('valAnesth', true)" class="text-slate-300 hover:text-teal-600"><i class="fa-regular fa-copy"></i></button></div>
                        </div>
                        <div class="flex items-center justify-between p-3 rounded-lg bg-slate-50 border border-slate-100">
                            <div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-white text-indigo-600 flex items-center justify-center shadow-sm"><i class="fa-solid fa-hospital text-xs"></i></div><div><p class="text-xs font-bold text-slate-700">Bloc / Salle</p><p class="text-[10px] text-slate-400" id="descClinic">--</p></div></div>
                            <div class="flex items-center gap-2"><span class="font-mono font-bold text-slate-700" id="valClinic">0</span><span class="text-slate-400 text-xs">€</span><button onclick="copyToClipboard('valClinic', true)" class="text-slate-300 hover:text-indigo-600"><i class="fa-regular fa-copy"></i></button></div>
                        </div>
                        <div id="rowStay" class="flex items-center justify-between p-3 rounded-lg bg-slate-50 border border-slate-100">
                            <div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-white text-orange-600 flex items-center justify-center shadow-sm"><i class="fa-solid fa-bed text-xs"></i></div><div><p class="text-xs font-bold text-slate-700">Hébergement</p><p class="text-[10px] text-slate-400" id="descStay">--</p></div></div>
                            <div class="flex items-center gap-2"><span class="font-mono font-bold text-slate-700" id="valStay">0</span><span class="text-slate-400 text-xs">€</span><button onclick="copyToClipboard('valStay', true)" class="text-slate-300 hover:text-orange-600"><i class="fa-regular fa-copy"></i></button></div>
                        </div>
                        <div id="rowImplants" class="hidden flex items-center justify-between p-3 rounded-lg bg-pink-50 border border-pink-100">
                            <div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-white text-pink-600 flex items-center justify-center shadow-sm"><i class="fa-solid fa-shapes text-xs"></i></div><div><p class="text-xs font-bold text-slate-700">Implants</p><p class="text-[10px] text-pink-400">Inclus</p></div></div>
                            <div class="flex items-center gap-2"><span class="font-mono font-bold text-slate-700" id="valImplants">0</span><span class="text-slate-400 text-xs">€</span><button onclick="copyToClipboard('valImplants', true)" class="text-pink-300 hover:text-pink-600"><i class="fa-regular fa-copy"></i></button></div>
                        </div>
                    </div>
                </div>
            </div>
            <p class="text-center text-[10px] text-slate-400 mt-4 px-4 italic" id="footerNote">* Prix calculé sur la base standard.</p>
        </div>

        <div id="emptyState" class="flex flex-col items-center justify-center py-12 text-slate-300">
            <i class="fa-solid fa-chart-pie text-6xl mb-4 text-slate-200"></i>
            <p class="text-sm font-medium">Sélectionnez une intervention</p>
        </div>
    </main>
    <div id="toast" class="fixed top-4 left-1/2 -translate-x-1/2 md:left-auto md:translate-x-0 md:right-4 bg-slate-900 text-white px-4 py-3 rounded-lg shadow-2xl flex items-center gap-3 transition-all duration-300 opacity-0 -translate-y-20 z-50 pointer-events-none"><i class="fa-solid fa-check text-green-400"></i><span class="text-sm font-bold">Copié !</span></div>

    <script>
        // --- DATA ---
        // V9: Data complète et corrigée (10/02/2026)
        const db = {
            "Abdominoplastie": { duration: 120, type: "Hospit 1 nuit", biarritz: { hc: 4200, anesth: 875, fso: 726, sejour: 533, implants: 0 } },
            "Abdominoplastie (SÉCU)": { duration: 120, type: "Hospit 1 nuit", biarritz: { hc: 4200, anesth: 725, fso: 0, sejour: 0, implants: 0 } },
            "Abdominoplastie + Cure hernie": { duration: 120, type: "Hospit 1 nuit", biarritz: { hc: 4200, anesth: 875, fso: 726, sejour: 533, implants: 0 } },
            "Ablation de prothèses": { duration: 60, type: "Ambulatoire", biarritz: { hc: 3600, anesth: 500, fso: 145.20, sejour: 408, implants: 0 } },
            "Ablation prothèses + Lipofilling": { duration: 120, type: "Ambulatoire", biarritz: { hc: 5500, anesth: 650, fso: 726, sejour: 408, implants: 0 } },
            "Ablation prothèses + Mastopexie": { duration: 120, type: "Ambulatoire", biarritz: { hc: 5500, anesth: 650, fso: 580.80, sejour: 408, implants: 0 } },
            "Augmentation Mammaire": { duration: 60, type: "Ambulatoire", biarritz: { hc: 3900, anesth: 600, fso: 435.60, sejour: 408, implants: 680 } },
            "Augmentation Mammaire Composite": { duration: 90, type: "Ambulatoire", biarritz: { hc: 4800, anesth: 750, fso: 726, sejour: 408, implants: 680 } },
            "Blépharoplastie 4 paupières": { duration: 120, type: "Ambulatoire", biarritz: { hc: 4500, anesth: 650, fso: 435.60, sejour: 408, implants: 0 } },
            "Blépharoplastie Inférieure": { duration: 90, type: "Ambulatoire", biarritz: { hc: 3500, anesth: 400, fso: 290.40, sejour: 408, implants: 0 } },
            "Blépharoplastie Supérieure": { duration: 60, type: "Ambulatoire", biarritz: { hc: 2600, anesth: 400, fso: 290.40, sejour: 408, implants: 0 } },
            "Changement de prothèses": { duration: 120, type: "Ambulatoire", biarritz: { hc: 4500, anesth: 600, fso: 290.40, sejour: 408, implants: 680 } },
            "Changement prothèses + Mastopexie": { duration: 150, type: "Ambulatoire", biarritz: { hc: 5500, anesth: 750, fso: 726, sejour: 408, implants: 680 } },
            "Lifting de bras": { duration: 120, type: "Ambulatoire", biarritz: { hc: 3900, anesth: 650, fso: 580.80, sejour: 408, implants: 0 } },
            "Lipoaspiration 1 site": { duration: 60, type: "Ambulatoire", biarritz: { hc: 3600, anesth: 650, fso: 726, sejour: 408, implants: 0 } },
            "Lipoaspiration 2 sites": { duration: 120, type: "Ambulatoire", biarritz: { hc: 4500, anesth: 650, fso: 726, sejour: 408, implants: 0 } },
            "Lipoaspiration 3 sites": { duration: 150, type: "Ambulatoire", biarritz: { hc: 5500, anesth: 750, fso: 726, sejour: 408, implants: 0 } },
            "Lipo DLA": { duration: 120, type: "Hospit 1 nuit", biarritz: { hc: 4800, anesth: 875, fso: 726, sejour: 533, implants: 0 } },
            "DLA + Lipo 1 site": { duration: 210, type: "Hospit 1 nuit", biarritz: { hc: 4900, anesth: 1000, fso: 0, sejour: 533, implants: 0 } },
            "Lipofilling mammaire >200g": { duration: 120, type: "Ambulatoire", biarritz: { hc: 4800, anesth: 750, fso: 726, sejour: 408, implants: 0 } },
            "Lipo sous-menton": { duration: 45, type: "Ambulatoire", biarritz: { hc: 2500, anesth: 0, fso: 0, sejour: 0, implants: 0 } },
            "Lipofilling cernes": { duration: 60, type: "Ambulatoire", biarritz: { hc: 1800, anesth: 0, fso: 0, sejour: 0, implants: 0 } },
            "Mastopexie": { duration: 90, type: "Ambulatoire", biarritz: { hc: 4200, anesth: 650, fso: 580.80, sejour: 408, implants: 0 } },
            "Mastopexie + Implants": { duration: 120, type: "Ambulatoire", biarritz: { hc: 4800, anesth: 750, fso: 726, sejour: 408, implants: 680 } },
            "Nymphoplastie (SÉCU)": { duration: 60, type: "Ambulatoire", biarritz: { hc: 2200, anesth: 350, fso: 0, sejour: 0, implants: 0 } }, 
            "Otoplastie (SÉCU)": { duration: 60, type: "Ambulatoire", biarritz: { hc: 1800, anesth: 600, fso: 0, sejour: 0, implants: 0 } }, 
            "Réduction Mammaire (SÉCU)": { duration: 90, type: "Ambulatoire", biarritz: { hc: 4500, anesth: 600, fso: 0, sejour: 0, implants: 0 } }, 
            "Rhinoplastie": { duration: 210, type: "Ambulatoire", biarritz: { hc: 5800, anesth: 1350, fso: 1567.20, sejour: 408, implants: 0 } },
            "Retouche Rhino": { duration: 60, type: "Ambulatoire", biarritz: { hc: 2800, anesth: 200, fso: 0, sejour: 0, implants: 0 } },
            "Rhino Secondaire": { duration: 240, type: "Ambulatoire", biarritz: { hc: 7200, anesth: 320, fso: 1567.20, sejour: 408, implants: 0 } },
            "Septorhinoplastie": { duration: 240, type: "Ambulatoire", biarritz: { hc: 6900, anesth: 1250, fso: 0, sejour: 0, implants: 0 } },
            "Septoplastie seule": { duration: 150, type: "Ambulatoire", biarritz: { hc: 0, anesth: 0, fso: 0, sejour: 0, implants: 0, note: "PEC Sécu" } }
        };

        let currentClinic = 'alphand';
        let currentKey = '';

        document.addEventListener('DOMContentLoaded', () => {
            const select = document.getElementById('interventionSelect');
            Object.keys(db).sort().forEach(key => {
                const opt = document.createElement('option');
                opt.value = key;
                opt.textContent = key;
                if(key.includes("(SÉCU)")) {
                    opt.classList.add('bg-green-50', 'text-green-700', 'font-medium');
                }
                select.appendChild(opt);
            });
            select.addEventListener('change', (e) => {
                currentKey = e.target.value;
                if(currentKey) loadInterventionData(currentKey);
                else hideResults();
            });
            document.getElementById('inputDuration').addEventListener('input', calculate);
            document.getElementById('inputType').addEventListener('change', calculate);
            document.getElementById('etoileStay').addEventListener('change', calculate); // New listener
            document.getElementById('valHC').addEventListener('input', updateTotalManual);
            document.getElementById('toggleHarmonization').addEventListener('change', calculate);
            setClinic('alphand');
        });

        function hideResults() {
            document.getElementById('emptyState').classList.remove('hidden');
            document.getElementById('resultCard').classList.add('hidden');
            document.getElementById('params-panel').classList.add('hidden');
        }

        function loadInterventionData(key) {
            const data = db[key];
            document.getElementById('inputDuration').value = data.duration;
            if (currentClinic === 'etoile') document.getElementById('inputType').value = 'Ambulatoire';
            else document.getElementById('inputType').value = data.type;
            
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('resultCard').classList.remove('hidden');
            document.getElementById('params-panel').classList.remove('hidden');
            calculate();
        }

        function setClinic(clinic) {
            currentClinic = clinic;
            document.querySelectorAll('.clinic-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${clinic}`).classList.add('active');
            document.getElementById('badgeClinic').textContent = { alphand: "Clinique Alphand", etoile: "Clinique Étoile", biarritz: "Clinique Biarritz" }[clinic];

            const typeSelect = document.getElementById('inputType');
            const etoileStayDiv = document.getElementById('etoile-stay-container');
            const etoileWarning = document.getElementById('etoile-warning');

            if (clinic === 'etoile') {
                typeSelect.value = 'Ambulatoire';
                typeSelect.disabled = true;
                etoileWarning.classList.remove('hidden');
                etoileStayDiv.classList.remove('hidden'); // Show Etoile specific stay
            } else {
                typeSelect.disabled = false;
                etoileWarning.classList.add('hidden');
                etoileStayDiv.classList.add('hidden'); // Hide Etoile specific stay
                if(currentKey) typeSelect.value = db[currentKey].type;
            }
            if(currentKey) calculate();
        }

        function calculate() {
            if (!currentKey) return;
            const duration = parseInt(document.getElementById('inputDuration').value) || 0;
            const type = document.getElementById('inputType').value;
            const data = db[currentKey];
            const isHarmonized = document.getElementById('toggleHarmonization').checked;

            document.getElementById('harmonization-status').textContent = isHarmonized ? "Harmonisation Active" : "Mode Standard";
            document.getElementById('harmonization-status').className = isHarmonized ? "text-[10px] uppercase font-bold text-green-600 transition-colors" : "text-[10px] uppercase font-bold text-slate-400 transition-colors";

            const baseHC = (data.biarritz && data.biarritz.hc) ? data.biarritz.hc : 0;
            const implantsCost = (data.biarritz && data.biarritz.implants) ? data.biarritz.implants : 0;
            
            // Reference (Alphand Standard)
            const refTech = calcAlphand(duration, data.type);
            const TARGET_TOTAL = refTech.total + baseHC + implantsCost;

            // Local Costs
            let localTech = { clinic: 0, anesth: 0, stay: 0 };
            if (currentClinic === 'alphand') localTech = calcAlphand(duration, type);
            else if (currentClinic === 'etoile') localTech = calcEtoile(duration); // Etoile now includes dynamic stay
            else if (currentClinic === 'biarritz') {
                if(data.biarritz) localTech = { clinic: data.biarritz.fso, anesth: data.biarritz.anesth, stay: data.biarritz.sejour };
            }

            const localTechTotal = localTech.clinic + localTech.anesth + localTech.stay + implantsCost;
            let computedHC = isHarmonized ? Math.max(TARGET_TOTAL - localTechTotal, baseHC) : baseHC;
            let profit = computedHC - baseHC;

            updateVisualTheme(isHarmonized);

            // Display
            document.getElementById('resTitle').innerHTML = currentKey + (currentKey.includes("(SÉCU)") ? '<span class="badge-secu">SÉCU</span>' : '');
            document.getElementById('badgeTime').textContent = duration + " min";
            document.getElementById('valHC').value = computedHC;
            document.getElementById('valAnesth').textContent = localTech.anesth;
            document.getElementById('valClinic').textContent = formatPrice(localTech.clinic);
            document.getElementById('valStay').textContent = localTech.stay;
            document.getElementById('resTotal').textContent = formatPrice(localTechTotal + computedHC) + " €";

            updateDescriptions(duration, type, data.biarritz);

            // Implants
            if (implantsCost > 0) {
                document.getElementById('rowImplants').classList.remove('hidden');
                document.getElementById('rowImplants').classList.add('flex');
                document.getElementById('valImplants').textContent = implantsCost;
            } else {
                document.getElementById('rowImplants').classList.add('hidden');
                document.getElementById('rowImplants').classList.remove('flex');
            }

            // Profit UI
            const badge = document.getElementById('profitBadge');
            if (isHarmonized && profit > 10) {
                badge.classList.remove('hidden');
                document.getElementById('profitAmount').textContent = "+" + formatPrice(profit) + " €";
                document.getElementById('hcSubtitle').textContent = "Harmonisé (" + formatPrice(profit) + "€ ajoutés)";
                document.getElementById('hcSubtitle').className = "text-xs font-bold text-green-600 mt-0.5 transition-colors";
                document.getElementById('footerNote').textContent = "* Prix aligné sur Alphand pour maximiser la marge.";
            } else {
                badge.classList.add('hidden');
                document.getElementById('hcSubtitle').textContent = "Standard (Base Biarritz)";
                document.getElementById('hcSubtitle').className = "text-xs text-slate-500 font-medium mt-0.5 transition-colors";
                document.getElementById('footerNote').textContent = "* Prix calculé sur la base standard.";
            }
        }

        function updateVisualTheme(isPremium) {
            const hcRow = document.getElementById('rowHC');
            const iconHC = document.getElementById('iconHC');
            const hcInput = document.getElementById('valHC');
            if(isPremium) {
                hcRow.className = "flex items-center justify-between p-4 rounded-xl bg-green-50 border border-green-200 ring-1 ring-green-300 transition-all duration-300 shadow-sm";
                iconHC.className = "w-12 h-12 rounded-full bg-white text-green-600 flex items-center justify-center shadow-sm";
                hcInput.className = "w-28 text-right font-mono text-2xl font-bold text-green-700 bg-transparent border-b border-green-300 focus:border-green-600 focus:outline-none p-0 transition-colors";
            } else {
                hcRow.className = "flex items-center justify-between p-4 rounded-xl bg-blue-50 border border-blue-100 ring-1 ring-blue-200 transition-all duration-300 shadow-sm";
                iconHC.className = "w-12 h-12 rounded-full bg-white text-blue-600 flex items-center justify-center shadow-sm";
                hcInput.className = "w-28 text-right font-mono text-2xl font-bold text-slate-900 bg-transparent border-b border-blue-300 focus:border-blue-500 focus:outline-none p-0 transition-colors";
            }
        }

        function calcAlphand(dur, type) {
            const blocks30 = Math.ceil(dur / 30);
            const billingDur = blocks30 * 30;
            const clinic = blocks30 * 375;
            let anesth = (billingDur <= 60) ? 500 : 500 + (Math.ceil((billingDur - 60) / 30) * 100);
            return { clinic, anesth, stay: (type === "Hospit 1 nuit" ? 650 : 350), total: clinic + anesth + (type === "Hospit 1 nuit" ? 650 : 350) };
        }

        function calcEtoile(dur) {
            const clinic = Math.ceil(dur / 15) * 190;
            let anesth = (dur <= 60) ? 500 : 500 + (Math.ceil((dur - 60) / 30) * 100);
            
            // Get selected stay type
            const stayCost = parseInt(document.getElementById('etoileStay').value) || 260;
            
            return { clinic, anesth, stay: stayCost, total: clinic + anesth + stayCost };
        }

        function updateDescriptions(dur, type, biarritzData) {
            if (currentClinic === 'alphand') {
                document.getElementById('descClinic').textContent = `Bloc 750€/h (${Math.ceil(dur / 30) * 30} min)`;
                document.getElementById('descAnesth').textContent = "500€ + 100€/30min";
                document.getElementById('descStay').textContent = type === "Hospit 1 nuit" ? "Nuit (650€)" : "Ambu (350€)";
            } else if (currentClinic === 'etoile') {
                document.getElementById('descClinic').textContent = `190€ / 15 min`;
                document.getElementById('descAnesth').textContent = "Idem Alphand";
                
                // Get text of selected option
                const sel = document.getElementById('etoileStay');
                const text = sel.options[sel.selectedIndex].text;
                document.getElementById('descStay').textContent = text;
            } else {
                document.getElementById('descClinic').textContent = `Forfait Salle (FSO)`;
                document.getElementById('descAnesth').textContent = "Forfait";
                document.getElementById('descStay').textContent = "Forfait Séjour";
            }
        }

        function updateTotalManual() {
            const hc = parseFloat(document.getElementById('valHC').value) || 0;
            const anesth = parseFloat(document.getElementById('valAnesth').textContent) || 0;
            const clinic = parseFloat(document.getElementById('valClinic').textContent.replace(/\s/g, '')) || 0;
            const stay = parseFloat(document.getElementById('valStay').textContent) || 0;
            const implants = parseFloat(document.getElementById('valImplants').textContent) || 0;
            document.getElementById('resTotal').textContent = formatPrice(hc + anesth + clinic + stay + implants) + " €";
            document.getElementById('profitBadge').classList.add('hidden');
            document.getElementById('hcSubtitle').textContent = "Modifié manuellement";
        }

        function formatPrice(num) { return parseFloat(num).toFixed(2).replace('.00', ''); }
        function copyToClipboard(id, txt) {
            let val = txt ? document.getElementById(id).textContent : document.getElementById(id).value;
            val = val.toString().replace(/\s€/g, '');
            if (navigator.clipboard) navigator.clipboard.writeText(val).then(showToast);
            else { const t = document.createElement("textarea"); t.value = val; document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t); showToast(); }
        }
        function showToast() { const t = document.getElementById('toast'); t.classList.remove('opacity-0', '-translate-y-20'); setTimeout(() => t.classList.add('opacity-0', '-translate-y-20'), 2000); }
    </script>
</body>
</html>
